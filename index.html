
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>نظام الفواتير الجزائري - نسخة الطباعة الدقيقة</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cairo:wght@400;700&family=Reem+Kufi:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f1f5f9;
            margin: 0;
            padding: 0;
            color: #000;
        }
        .font-amiri { font-family: 'Amiri', serif; }
        .font-reem { font-family: 'Reem Kufi', sans-serif; }
        
        /* إعدادات الطباعة الاحترافية الصارمة */
        @media print {
            @page {
                size: A4;
                margin: 0;
            }
            html, body {
                width: 210mm;
                height: 297mm;
                background-color: #fff !important;
                color: #000 !important;
            }
            .no-print {
                display: none !important;
            }
            .print-container {
                padding: 0 !important;
                margin: 0 !important;
                width: 210mm !important;
            }
            .invoice-page {
                width: 210mm !important;
                height: 296mm !important; /* تقليل طفيف لضمان صفحة واحدة */
                padding: 10mm !important;
                margin: 0 !important;
                page-break-after: always !important;
                border: none !important;
                box-shadow: none !important;
                display: flex !important;
                flex-direction: column !important;
                box-sizing: border-box !important;
                overflow: hidden !important;
                background: white !important;
            }
            /* إجبار لون الخط على الأسود في الطباعة */
            * {
                color: #000 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            .bg-black-print { background-color: #000 !important; color: #fff !important; }
            .bg-blue-print { background-color: #1e3a8a !important; color: #fff !important; }
        }

        /* تنسيق الشاشة */
        .invoice-page {
            width: 210mm;
            height: 297mm;
            background: white;
            margin: 20px auto;
            padding: 15mm;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            border: 1px solid #ddd;
            color: #000;
        }

        .table-custom {
            width: 100%;
            border-collapse: collapse;
            border: 2pt solid #000;
        }
        .table-custom th {
            background-color: #000 !important;
            color: #fff !important;
            border: 1.5pt solid #000;
            padding: 8px;
            font-size: 12px;
        }
        .table-custom td {
            border: 1.5pt solid #000;
            padding: 8px;
            font-size: 14px;
            color: #000;
            font-weight: 600;
        }
        .border-heavy {
            border: 2pt solid #000 !important;
        }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.4",
    "react-dom/": "https://esm.sh/react-dom@^19.2.4/",
    "lucide-react": "https://esm.sh/lucide-react@^0.563.0",
    "react/": "https://esm.sh/react@^19.2.4/"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'https://esm.sh/react@18.2.0';
        import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            Plus, Trash2, Printer, FileText, RotateCcw, 
            Save, Building2, Truck 
        } from 'https://esm.sh/lucide-react@0.263.1';

        const convertAmountToWords = (amount) => {
            return `هذه الفاتورة محددة بمبلغ إجمالي قدره: ${amount.toLocaleString('ar-DZ')} دينار جزائري فقط لا غير.`;
        };

        const InvoicePreview = ({ data }) => {
            const subtotal = data.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const tvaAmount = subtotal * (data.tvaRate / 100);
            const timbre = data.paymentMethod === 'CASH' ? Math.min(Math.max((subtotal + tvaAmount) * 0.01, 5), 10000) : 0;
            const total = subtotal + tvaAmount + timbre;

            return (
                <div className="invoice-page text-black">
                    {/* الترويسة */}
                    <div className="text-center border-b-4 border-black pb-4 mb-4">
                        <h1 className="text-4xl font-reem font-bold mb-1 text-black">{data.company.name}</h1>
                        <p className="text-[14px] font-amiri font-bold">{data.company.address} | الهاتف: {data.company.phone}</p>
                        
                        <div className="flex justify-between items-center mt-6 px-4">
                            <div dir="ltr" className="text-[10px] font-mono text-black text-left border-l-4 border-black pl-4 leading-relaxed font-bold">
                                <div>RC: {data.company.rc}</div>
                                <div>NIF: {data.company.nif}</div>
                                <div>NIS: {data.company.nis}</div>
                                <div>AI: {data.company.ai}</div>
                            </div>
                            <div className="bg-black text-white px-8 py-3 rounded-lg border-4 border-black bg-black-print">
                                <h2 className="text-3xl font-bold font-reem">فـاتـورة</h2>
                                <p className="text-[12px] font-mono mt-1">N°: {data.invoiceNumber}</p>
                            </div>
                        </div>
                    </div>

                    {/* بيانات الزبون */}
                    <div className="grid grid-cols-2 gap-6 mb-6">
                        <div className="border-heavy p-4 rounded-xl bg-gray-50/50">
                            <h4 className="text-[11px] font-bold border-b-2 border-black mb-2 pb-1">السيد / المؤسسة (الزبون):</h4>
                            <div className="font-bold text-2xl font-amiri text-black">{data.client.name}</div>
                            <div className="text-[14px] mt-1 font-bold">{data.client.address}</div>
                            <div className="text-[13px] mt-1">الهاتف: {data.client.phone}</div>
                        </div>
                        <div className="border-heavy p-4 rounded-xl text-left flex flex-col justify-center gap-2">
                            <div className="text-[14px] font-bold">تاريخ الإصدار: <span className="mr-2">{data.date}</span></div>
                            <div className="text-[14px] font-bold">تاريخ الاستحقاق: <span className="mr-2">{data.dueDate}</span></div>
                            <div className="mt-2 font-bold text-[12px] bg-black text-white px-4 py-1 inline-block rounded-full self-start bg-black-print">
                                طريقة الدفع: {data.paymentMethod === 'CASH' ? 'نقداً' : 'تحويل بنكي / صك'}
                            </div>
                        </div>
                    </div>

                    {/* الجدول الصارم */}
                    <div className="flex-grow">
                        <table className="table-custom">
                            <thead>
                                <tr className="bg-black-print">
                                    <th className="w-12 text-center">#</th>
                                    <th className="text-right">الوصف والبيان (تعيين السلعة)</th>
                                    <th className="w-24 text-center">الكمية</th>
                                    <th className="w-32 text-center">سعر الوحدة</th>
                                    <th className="w-40 text-left">المبلغ الصافي</th>
                                </tr>
                            </thead>
                            <tbody>
                                {data.items.map((item, idx) => (
                                    <tr key={item.id}>
                                        <td className="text-center font-bold">{idx + 1}</td>
                                        <td className="font-amiri font-bold text-lg">{item.description}</td>
                                        <td className="text-center font-bold text-lg">{item.quantity}</td>
                                        <td className="text-center font-bold">{item.price.toLocaleString()}</td>
                                        <td className="text-left font-bold text-lg">{(item.price * item.quantity).toLocaleString()}</td>
                                    </tr>
                                ))}
                                {/* حقول فارغة لتعبئة الجدول */}
                                {[...Array(Math.max(0, 10 - data.items.length))].map((_, i) => (
                                    <tr key={i} className="h-10"><td colSpan={5}></td></tr>
                                ))}
                            </tbody>
                        </table>
                    </div>

                    {/* الخلاصة والنتائج */}
                    <div className="mt-6 flex gap-6">
                        <div className="flex-grow border-heavy p-4 rounded-xl">
                            <h4 className="text-[12px] font-bold mb-2 border-b border-black inline-block">المبلغ الإجمالي بالحروف:</h4>
                            <p className="text-[16px] font-amiri font-bold italic text-black leading-relaxed">{convertAmountToWords(total)}</p>
                            <div className="mt-6 text-[11px] font-bold italic text-gray-700">ملاحظات: {data.notes}</div>
                        </div>
                        <div className="w-72 border-heavy p-4 rounded-xl space-y-2 bg-gray-50/50">
                            <div className="flex justify-between text-[13px] font-bold"><span>المجموع (HT):</span><span>{subtotal.toLocaleString()} دج</span></div>
                            <div className="flex justify-between text-[13px] font-bold"><span>TVA ({data.tvaRate}%):</span><span>{tvaAmount.toLocaleString()} دج</span></div>
                            {timbre > 0 && <div className="flex justify-between text-[13px] border-t-2 border-black pt-2 font-bold"><span>حق الطابع:</span><span>{timbre.toLocaleString()} دج</span></div>}
                            <div className="flex justify-between text-xl font-bold border-t-4 border-black pt-2 mt-2"><span>الإجمالي النهائي:</span><span className="text-red-700">{total.toLocaleString()} دج</span></div>
                        </div>
                    </div>

                    {/* التوقيع والختم - مكبر وأوضح */}
                    <div className="mt-8 flex justify-end">
                        <div className="text-center border-heavy p-8 rounded-2xl w-80 min-h-[160px] relative">
                            <p className="text-[13px] font-bold uppercase mb-20 border-b border-black pb-1">ختم وإمضاء المؤسسة</p>
                            <div className="absolute inset-0 flex items-center justify-center opacity-10 pointer-events-none">
                                <div className="border-4 border-black rounded-full w-32 h-32 flex items-center justify-center rotate-12">
                                    <span className="text-black font-bold text-sm uppercase">ORIGINAL</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const DeliveryNotePreview = ({ data }) => {
            return (
                <div className="invoice-page text-black border-blue-100">
                    <div className="text-center border-b-4 border-black pb-4 mb-4">
                        <h1 className="text-4xl font-reem font-bold mb-1 text-black">{data.company.name}</h1>
                        <p className="text-[14px] font-amiri font-bold">{data.company.address}</p>
                        <div className="flex justify-between items-center mt-6">
                            <div className="text-[11px] font-bold border-l-4 border-blue-800 pl-4 font-mono">Bordereau de Livraison</div>
                            <div className="bg-blue-900 text-white px-10 py-3 rounded-lg border-4 border-black bg-blue-print">
                                <h2 className="text-2xl font-bold font-reem">سند تسليم</h2>
                                <p className="text-[12px] font-mono mt-1">N°: {data.invoiceNumber}</p>
                            </div>
                        </div>
                    </div>

                    <div className="border-heavy p-5 rounded-2xl mb-6 bg-blue-50/30">
                        <h4 className="text-[11px] font-bold border-b-2 border-black mb-2 pb-1">المرسل إليه (الزبون):</h4>
                        <div className="text-2xl font-bold font-amiri text-black">{data.client.name}</div>
                        <div className="text-[15px] font-bold mt-1">{data.client.address}</div>
                        <div className="text-[14px] mt-4 font-bold">تاريخ التسليم الفعلي: <span className="mr-2 underline">{data.date}</span></div>
                    </div>

                    <div className="flex-grow">
                        <table className="table-custom">
                            <thead className="bg-blue-print">
                                <tr>
                                    <th className="w-14 text-center">#</th>
                                    <th className="text-right">تعيين السلع المسلمة</th>
                                    <th className="w-40 text-center">الكمية</th>
                                </tr>
                            </thead>
                            <tbody>
                                {data.items.map((item, idx) => (
                                    <tr key={item.id}>
                                        <td className="text-center font-bold text-lg">{idx + 1}</td>
                                        <td className="font-amiri font-bold text-xl">{item.description}</td>
                                        <td className="text-center text-2xl font-bold">{item.quantity}</td>
                                    </tr>
                                ))}
                                {[...Array(Math.max(0, 12 - data.items.length))].map((_, i) => (
                                    <tr key={i} className="h-12"><td colSpan={3}></td></tr>
                                ))}
                            </tbody>
                        </table>
                    </div>

                    <div className="mt-12 grid grid-cols-2 gap-16">
                        <div className="text-center border-heavy p-6 rounded-2xl min-h-[180px]">
                            <p className="text-[12px] font-bold mb-24 uppercase border-b border-black pb-1">إمضاء واستلام الزبون</p>
                            <p className="text-[10px] text-gray-500 italic">أقر أنا الموقع أدناه باستلام السلع المذكورة أعلاه في حالة جيدة</p>
                        </div>
                        <div className="text-center border-heavy p-6 rounded-2xl min-h-[180px]">
                            <p className="text-[12px] font-bold mb-24 uppercase border-b border-black pb-1">ختم وإمضاء المؤسسة</p>
                            <div className="absolute top-1/2 right-1/4 w-32 h-32 border-2 border-blue-200 rounded-full opacity-5 rotate-12 pointer-events-none"></div>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('editor');
            const [company, setCompany] = useState(() => JSON.parse(localStorage.getItem('dz_comp_v5') || '{"name":"مؤسسة الابتكار للخدمات","address":"حي 1200 مسكن، الجزائر العاصمة","phone":"023 45 67 89","rc":"16/00-12345B21","nif":"001234567890123","nis":"1920000123456","ai":"16001234567"}'));
            const [clients, setClients] = useState(() => JSON.parse(localStorage.getItem('dz_clients_v5') || '[]'));
            const [archive, setArchive] = useState(() => JSON.parse(localStorage.getItem('dz_archive_v5') || '[]'));

            const createNew = (c) => ({
                id: Math.random().toString(36).substr(2, 9),
                invoiceNumber: `${new Date().getFullYear()}/${Math.floor(Math.random()*900)+100}`,
                date: new Date().toISOString().split('T')[0],
                dueDate: new Date(Date.now()+2592000000).toISOString().split('T')[0],
                company: c,
                client: { name: "", address: "", phone: "" },
                items: [{ id: '1', description: '', price: 0, quantity: 1 }],
                tvaRate: 19,
                paymentMethod: 'TRANSFER',
                notes: "السلعة المباعة لا ترد ولا تستبدل بعد مرور 48 ساعة."
            });

            const [data, setData] = useState(() => createNew(company));

            useEffect(() => { localStorage.setItem('dz_comp_v5', JSON.stringify(company)); setData(prev => ({...prev, company})); }, [company]);
            useEffect(() => localStorage.setItem('dz_clients_v5', JSON.stringify(clients)), [clients]);
            useEffect(() => localStorage.setItem('dz_archive_v5', JSON.stringify(archive)), [archive]);

            const Input = ({ label, value, onChange, type="text", className="" }) => (
                <div className={className}>
                    <label className="text-[11px] font-bold text-gray-500 block mb-1 uppercase">{label}</label>
                    <input type={type} className="w-full px-4 py-2 border-2 border-gray-200 rounded-xl text-sm font-bold focus:border-black outline-none transition-all" value={value} onChange={e => onChange(e.target.value)} />
                </div>
            );

            return (
                <div className="min-h-screen text-black">
                    <header className="no-print bg-white border-b-2 border-gray-200 sticky top-0 z-50 px-6 py-4 flex justify-between items-center shadow-md">
                        <div className="flex items-center gap-3">
                            <div className="bg-black text-white p-2 rounded-lg"><FileText size={24}/></div>
                            <h1 className="text-2xl font-bold font-reem">نظام الفواتير الجزائري</h1>
                        </div>
                        <nav className="flex gap-2 bg-gray-100 p-1.5 rounded-2xl">
                            {['settings', 'clients', 'editor', 'archive'].map(tab => (
                                <button key={tab} onClick={() => setActiveTab(tab)} className={`px-6 py-2 rounded-xl text-[14px] font-bold transition-all ${activeTab === tab ? 'bg-black text-white shadow-lg' : 'text-gray-600 hover:text-black'}`}>
                                    {tab === 'settings' ? 'المؤسسة' : tab === 'clients' ? 'العملاء' : tab === 'editor' ? 'الفاتورة' : 'الأرشيف'}
                                </button>
                            ))}
                        </nav>
                        <div className="flex gap-2">
                            {activeTab === 'editor' && (
                                <button onClick={() => window.print()} className="bg-red-600 text-white px-8 py-2.5 rounded-xl font-bold flex items-center gap-2 shadow-lg hover:bg-red-700 active:scale-95 transition-all"><Printer size={20}/> طباعة الفاتورة والسند</button>
                            )}
                        </div>
                    </header>

                    <main className="max-w-[1600px] mx-auto mt-8 px-6 pb-20">
                        {activeTab === 'editor' && (
                            <div className="grid grid-cols-1 xl:grid-cols-5 gap-10 items-start">
                                <div className="no-print xl:col-span-2 space-y-6">
                                    <div className="bg-white p-8 rounded-3xl border-2 border-gray-100 shadow-sm">
                                        <h2 className="text-xl font-bold mb-6 border-b pb-4">بيانات الفاتورة والزبون</h2>
                                        <div className="grid grid-cols-2 gap-5">
                                            <Input label="رقم الفاتورة" value={data.invoiceNumber} onChange={v=>setData({...data, invoiceNumber:v})} />
                                            <Input label="التاريخ" type="date" value={data.date} onChange={v=>setData({...data, date:v})} />
                                            <Input label="اسم الزبون" value={data.client.name} onChange={v=>setData(d=>({...d, client:{...d.client, name:v}}))} className="col-span-2" />
                                            <Input label="عنوان الزبون" value={data.client.address} onChange={v=>setData(d=>({...d, client:{...d.client, address:v}}))} className="col-span-2" />
                                        </div>
                                    </div>
                                    <div className="bg-white p-8 rounded-3xl border-2 border-gray-100 shadow-sm">
                                        <div className="flex justify-between items-center mb-6"><h2 className="text-xl font-bold">جدول السلع</h2><button onClick={()=>setData(p=>({...p, items:[...p.items,{id:Date.now().toString(),description:'',price:0,quantity:1}]}))} className="bg-black text-white px-4 py-2 rounded-xl text-xs font-bold shadow-md hover:bg-gray-800 transition-all">+ إضافة سطر جديد</button></div>
                                        <div className="space-y-4">
                                            {data.items.map(item => (
                                                <div key={item.id} className="flex gap-3 items-end bg-gray-50 p-4 rounded-2xl border-2 border-gray-100">
                                                    <div className="flex-grow"><input className="w-full p-2.5 border-2 border-gray-200 rounded-xl text-sm font-bold" placeholder="وصف السلعة" value={item.description} onChange={e=>setData(d=>({...d, items:d.items.map(it=>it.id===item.id?{...it,description:e.target.value}:it)}))} /></div>
                                                    <div className="w-20"><input type="number" className="w-full p-2.5 border-2 border-gray-200 rounded-xl text-sm text-center font-bold" value={item.quantity} onChange={e=>setData(d=>({...d, items:d.items.map(it=>it.id===item.id?{...it,quantity:parseFloat(e.target.value)||0}:it)}))} /></div>
                                                    <div className="w-32"><input type="number" className="w-full p-2.5 border-2 border-gray-200 rounded-xl text-sm font-bold" value={item.price} onChange={e=>setData(d=>({...d, items:d.items.map(it=>it.id===item.id?{...it,price:parseFloat(e.target.value)||0}:it)}))} /></div>
                                                    <button onClick={()=>setData(d=>({...d, items:d.items.filter(it=>it.id!==item.id)}))} className="text-red-500 font-bold p-2 hover:bg-red-50 rounded-lg transition-all">×</button>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                                <div className="xl:col-span-3 print-container">
                                    <div className="flex flex-col gap-12 bg-gray-200 p-10 rounded-[60px] shadow-inner border-4 border-gray-300">
                                        <InvoicePreview data={data} />
                                        <DeliveryNotePreview data={data} />
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'settings' && (
                            <div className="max-w-3xl mx-auto bg-white p-12 rounded-[40px] border-2 border-gray-100 shadow-xl">
                                <h2 className="text-3xl font-bold mb-10 border-b-4 border-black pb-4">إعدادات المؤسسة الرئيسية</h2>
                                <div className="grid gap-8">
                                    <Input label="اسم المؤسسة الرسمي" value={company.name} onChange={v=>setCompany({...company, name:v})} />
                                    <Input label="العنوان الجغرافي الكامل" value={company.address} onChange={v=>setCompany({...company, address:v})} />
                                    <Input label="أرقام الهاتف" value={company.phone} onChange={v=>setCompany({...company, phone:v})} />
                                    <div className="grid grid-cols-2 gap-6 p-6 bg-gray-50 rounded-3xl border-2 border-gray-100">
                                        <Input label="السجل التجاري (RC)" value={company.rc} onChange={v=>setCompany({...company, rc:v})} />
                                        <Input label="الرقم التعريفي الضريبي (NIF)" value={company.nif} onChange={v=>setCompany({...company, nif:v})} />
                                        <Input label="الرقم الإحصائي (NIS)" value={company.nis} onChange={v=>setCompany({...company, nis:v})} />
                                        <Input label="رقم المادة (AI)" value={company.ai} onChange={v=>setCompany({...company, ai:v})} />
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'clients' && (
                            <div className="bg-white p-10 rounded-[40px] border-2 shadow-sm">
                                <div className="flex justify-between items-center mb-10">
                                    <h2 className="text-3xl font-bold font-reem">دليل العملاء والزبائن</h2>
                                    <button onClick={()=>setClients([{id:Date.now().toString(),name:'زبون جديد',address:'',phone:''},...clients])} className="bg-black text-white px-8 py-3 rounded-2xl font-bold shadow-lg hover:bg-gray-800 transition-all">+ إضافة زبون جديد</button>
                                </div>
                                <div className="grid md:grid-cols-3 gap-8">
                                    {clients.map(c => (
                                        <div key={c.id} className="p-8 border-2 border-gray-100 rounded-[30px] bg-gray-50 hover:border-black transition-all group">
                                            <Input label="الاسم الكامل" value={c.name} onChange={v=>setClients(clients.map(cl=>cl.id===c.id?{...cl,name:v}:cl))} />
                                            <Input label="العنوان" className="mt-4" value={c.address} onChange={v=>setClients(clients.map(cl=>cl.id===c.id?{...cl,address:v}:cl))} />
                                            <button onClick={()=>{setData({...data, client:c}); setActiveTab('editor');}} className="w-full mt-6 bg-white border-2 border-black text-black py-3 rounded-2xl font-bold hover:bg-black hover:text-white transition-all shadow-sm">اختيار وتجهيز فاتورة</button>
                                            <button onClick={()=>setClients(clients.filter(cl=>cl.id!==c.id))} className="w-full mt-2 text-red-400 text-xs font-bold hover:text-red-600">حذف من القائمة</button>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
